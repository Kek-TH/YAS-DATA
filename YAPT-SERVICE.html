<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signInWithPopup,
    GoogleAuthProvider,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAzNykwZ6VoV_nteMQEo3oRDaX7Ca59Ti4",
    authDomain: "yaskawa-web-th.firebaseapp.com",
    projectId: "yaskawa-web-th",
    storageBucket: "yaskawa-web-th.appspot.com",
    messagingSenderId: "117479927006",
    appId: "1:117479927006:web:0b4ce8fef4c0428bdea64f",
    measurementId: "G-63TQB1N2K9"
  };

  // Firebase Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // DOM Elements
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const emailModal = document.getElementById("email-login-modal");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const emailLoginSubmit = document.getElementById("email-login-submit");
  const emailLoginCancel = document.getElementById("email-login-cancel");
  const googleLoginBtn = document.getElementById("google-login-btn");
  const loginError = document.getElementById("login-error");
  const alarmLinks = document.querySelectorAll(".alarm-link");
  const userInfo = document.getElementById("user-info");

  // Helper functions
  const showModal = () => {
    emailModal.classList.remove("hidden");
    emailModal.classList.add("flex");
    loginError.classList.add("hidden");
  };

  const hideModal = () => {
    emailModal.classList.add("hidden");
    emailModal.classList.remove("flex");
    loginError.classList.add("hidden");
  };

  // Button events
  loginBtn.onclick = showModal;
  emailLoginCancel.onclick = hideModal;

  emailModal.addEventListener("click", (e) => {
    if (e.target === emailModal) hideModal();
  });

  // Email login
  emailLoginSubmit.onclick = () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    signInWithEmailAndPassword(auth, email, password)
      .then(hideModal)
      .catch((error) => {
        console.error("Email login error:", error.message);
        loginError.classList.remove("hidden");
      });
  };

  // Google login
  googleLoginBtn.onclick = () => {
    signInWithPopup(auth, provider)
      .then(hideModal)
      .catch((error) => {
        console.error("Google login error:", error.message);
        loginError.classList.remove("hidden");
      });
  };

  // Prevent page link if not logged in
  alarmLinks.forEach(link => {
    link.addEventListener("click", (e) => {
      if (!auth.currentUser) {
        e.preventDefault();
        showModal();
      }
    });
  });

  // Logout
  logoutBtn.onclick = () => {
    signOut(auth);
  };

  // Handle Auth state changes
  onAuthStateChanged(auth, (user) => {
    const isLoggedIn = !!user;
    loginBtn.classList.toggle("hidden", isLoggedIn);
    logoutBtn.classList.toggle("hidden", !isLoggedIn);
    userInfo.classList.toggle("hidden", !isLoggedIn);

    if (isLoggedIn) {
      const name = user.displayName || user.email || "User";
      userInfo.textContent = `Hello, ${name}`;
      console.log("Logged in as:", name);
    }
  });
</script>
